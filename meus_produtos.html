<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DIGIVEND ‚Äî Meus Produtos</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-950 text-white min-h-screen font-sans">

  <!-- SIDEBAR -->
  <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-gray-900 transform -translate-x-full transition-transform duration-300 z-50">
    <div class="flex items-center justify-between px-4 py-4 border-b border-gray-800">
      <h2 class="text-xl font-bold text-blue-400">DIGIVEND</h2>
      <button id="close-sidebar" class="text-gray-400 hover:text-white text-2xl font-bold">√ó</button>
    </div>
    <nav class="p-4 space-y-2">
      <a href="dashboard_vendedor.html" class="menu-item block px-3 py-2 rounded hover:bg-gray-800">üè† Dashboard</a>
      <a href="meus_produtos.html" class="menu-item block px-3 py-2 rounded bg-gray-800 text-blue-400">üì¶ Meus Produtos</a>
      <a href="vendas.html" class="menu-item block px-3 py-2 rounded hover:bg-gray-800">üí∞ Vendas</a>
      <a href="saques.html" class="menu-item block px-3 py-2 rounded hover:bg-gray-800">üí∏ Saques</a>
      <a href="afiliados.html" class="menu-item block px-3 py-2 rounded hover:bg-gray-800">üë• Afiliados</a>
      <a href="configuracoes.html" class="menu-item block px-3 py-2 rounded hover:bg-gray-800">‚öôÔ∏è Configura√ß√µes</a>
      <a href="index.html" class="block px-3 py-2 rounded text-red-500 hover:bg-gray-800">üö™ Sair</a>
    </nav>
  </aside>

  <!-- TOPBAR -->
  <header class="flex items-center justify-between px-6 py-4 bg-gray-900 shadow-md sticky top-0 z-40">
    <div class="flex items-center gap-4">
      <button id="open-sidebar" class="text-white text-2xl">‚ò∞</button>
      <h1 class="text-2xl font-bold text-blue-400">Meus Produtos</h1>
    </div>

    <div class="flex items-center gap-4">
      <!-- Notifica√ß√µes -->
      <div class="relative">
        <button id="bellBtn" class="p-1 rounded hover:bg-gray-800">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.6">
            <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v4c0 .538-.214 1.055-.595 1.436L4 17h5"/>
            <path d="M9 17a3 3 0 006 0"/>
          </svg>
          <span id="bellCount" class="absolute -top-1 -right-1 bg-red-600 text-white text-[11px] rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
        </button>

        <!-- bell dropdown -->
        <div id="bellDropdown" class="hidden absolute right-0 mt-2 w-80 max-h-96 overflow-y-auto bg-gray-800 border border-gray-700 rounded-xl shadow-lg p-2 z-50">
          <div class="px-3 py-2 border-b border-gray-700 text-blue-300 font-semibold flex justify-between items-center">
            <span>Notifica√ß√µes</span>
            <button id="markAllRead" class="text-xs text-gray-300 hover:text-white">Marcar todas lidas</button>
          </div>
          <div id="bellItems" class="p-2 space-y-2"></div>
          <div class="px-3 py-2 border-t border-gray-700 text-xs text-gray-400">Clique para abrir</div>
        </div>
      </div>

      <!-- Perfil -->
      <div class="relative">
        <button id="profileBtn" class="w-9 h-9 rounded-full bg-blue-600 flex items-center justify-center font-bold">V</button>
        <div id="profileMenu" class="hidden absolute right-0 mt-2 w-44 bg-gray-800 rounded-lg shadow-lg border border-gray-700 z-50">
          <a href="index.html" class="block px-4 py-2 hover:bg-gray-700">Marketplace</a>
          <a href="perfil.html" class="block px-4 py-2 hover:bg-gray-700">Perfil</a>
          <button id="logoutBtn" class="w-full text-left px-4 py-2 text-red-500 hover:bg-gray-700">Sair</button>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN CONTAINER - centered, no horizontal scroll -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Top area: centered search -->
    <div class="flex flex-col items-center gap-4">
      <div class="w-full max-w-2xl">
        <div class="relative">
          <input id="searchInput" type="search" placeholder="Pesquisar produtos..." class="w-full p-3 rounded-lg bg-gray-800 placeholder-gray-400 outline-none text-sm" />
          <button id="filterToggle" class="absolute right-1 top-1/2 -translate-y-1/2 bg-blue-600 px-3 py-1 rounded hover:bg-blue-700 text-sm">FiltrarCategoria</button>
        </div>

        <!-- dropdown categories (hidden until click) -->
        <div id="catDropdown" class="hidden mt-2 w-full bg-gray-800 border border-gray-700 rounded p-3 grid grid-cols-2 gap-2 z-40">
          <button class="catOpt px-3 py-1 rounded bg-gray-900 text-sm" data-cat="Todos">Todos</button>
          <button class="catOpt px-3 py-1 rounded bg-gray-900 text-sm" data-cat="Empreender">Empreender</button>
          <button class="catOpt px-3 py-1 rounded bg-gray-900 text-sm" data-cat="Neg√≥cios">Neg√≥cios</button>
          <button class="catOpt px-3 py-1 rounded bg-gray-900 text-sm" data-cat="Sa√∫de">Sa√∫de</button>
          <button class="catOpt px-3 py-1 rounded bg-gray-900 text-sm" data-cat="Fitness">Fitness</button>
          <button class="catOpt px-3 py-1 rounded bg-gray-900 text-sm" data-cat="Educa√ß√£o">Educa√ß√£o</button>
          <button class="catOpt px-3 py-1 rounded bg-gray-900 text-sm" data-cat="Outros">Outros</button>
        </div>
      </div>

      <!-- small create button aligned left below search (we center container so use flex) -->
      <div class="w-full max-w-2xl flex items-center">
        <div class="flex-1">
          <button id="createProductBtn" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm shadow">+ Criar</button>
        </div>
        <div class="text-sm text-gray-400"> </div>
      </div>
    </div>

    <!-- products grid -->
    <section id="productGrid" class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></section>
  </main>

  <!-- MODAL: 3-step product creation (modal internal scroll) -->
  <div id="productModal" class="hidden fixed inset-0 bg-black/70 flex items-start justify-center pt-16 z-50">
    <div class="bg-gray-900 w-[960px] max-w-full rounded-2xl border border-blue-600 shadow-lg overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b border-gray-800">
        <div class="flex items-center gap-4">
          <h3 class="text-xl font-semibold text-blue-300" id="modalTitle">Criar Produto</h3>
          <div class="text-sm text-gray-400" id="stepIndicator">Etapa 1 de 3</div>
        </div>
        <div>
          <button id="modalClose" class="text-gray-300 hover:text-white text-2xl">‚úï</button>
        </div>
      </div>

      <div class="p-4 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="max-h-[70vh] overflow-y-auto pr-2 space-y-4">
          <div id="step1">
            <label class="block text-sm text-gray-300">Imagem do produto (Obrigat√≥rio)</label>
            <input id="inputImage" type="file" accept="image/*" class="mt-2 w-full text-sm text-gray-300"/>

            <div>
              <label class="block text-sm text-gray-300 mt-3">Nome do Produto *</label>
              <input id="inputName" type="text" placeholder="escreva o nome aqui" class="mt-2 w-full p-2 bg-gray-800 rounded text-sm" />
            </div>

            <div class="grid grid-cols-3 gap-2 mt-2">
              <div>
                <label class="text-sm text-gray-300">Pre√ßo (MZN)</label>
                <input id="inputPrice" type="number" min="0" placeholder="99" class="mt-2 w-full p-2 bg-gray-800 rounded text-sm" />
              </div>
              <div>
                <label class="text-sm text-gray-300">Desconto %</label>
                <input id="inputDiscount" type="number" min="0" max="100" placeholder="0" class="mt-2 w-full p-2 bg-gray-800 rounded text-sm"/>
              </div>
              <div>
                <label class="text-sm text-gray-300">Cupom</label>
                <input id="inputCoupon" type="text" placeholder="CUPOMZ" class="mt-2 w-full p-2 bg-gray-800 rounded text-sm"/>
              </div>
            </div>

            <div class="mt-3">
              <label class="text-sm text-gray-300">Pre√ßo final</label>
              <div id="finalPrice" class="mt-2 text-lg font-bold">0 MZN</div>
            </div>

            <div class="mt-3">
              <label class="block text-sm text-gray-300">Descri√ß√£o (m√≠n 150 caracteres)</label>
              <textarea id="inputDesc" rows="6" placeholder="escreva algo aqui..." class="mt-2 w-full p-2 bg-gray-800 rounded text-sm"></textarea>
              <div class="text-xs text-gray-400 mt-1">Caracteres: <span id="descCount">0</span>/150</div>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <div>
                <label class="text-sm text-gray-300">Categoria</label>
                <select id="inputCategory" class="mt-2 w-full p-2 bg-gray-800 rounded text-sm">
                  <option>Empreender</option>
                  <option>Neg√≥cios</option>
                  <option>Sa√∫de</option>
                  <option>Fitness</option>
                  <option>Educa√ß√£o</option>
                  <option>Outros</option>
                </select>
              </div>
              <div>
                <label class="text-sm text-gray-300">Tipo de produto</label>
                <select id="inputType" class="mt-2 w-full p-2 bg-gray-800 rounded text-sm">
                  <option>Ebook</option>
                  <option>Curso Online</option>
                  <option>Aplicativo</option>
                </select>
              </div>
            </div>

            <div class="mt-3 flex items-center gap-2">
              <input id="allowAff" type="checkbox" />
              <label class="text-sm text-gray-300">Permitir Afiliados</label>
            </div>

            <div id="affSection" class="hidden mt-3 bg-gray-850 p-3 rounded">
              <div class="grid grid-cols-3 gap-2">
                <div>
                  <label class="text-sm text-gray-300">Comiss√£o %</label>
                  <input id="affCommission" type="number" min="0" max="100" value="10" class="mt-2 w-full p-2 bg-gray-800 rounded text-sm"/>
                </div>
                <div>
                  <label class="text-sm text-gray-300">Valor afiliado</label>
                  <div id="affValue" class="mt-2 p-2 bg-gray-900 rounded text-sm">0 MZN</div>
                </div>
                <div>
                  <label class="text-sm text-gray-300">Link do afiliado</label>
                  <input id="affLink" type="text" placeholder="https://..." class="mt-2 w-full p-2 bg-gray-800 rounded text-sm"/>
                </div>
              </div>
            </div>
          </div>

          <div id="step2" class="hidden">
            <label class="block text-sm text-gray-300">Upload do arquivo (PDF) ‚Äî Ebook (3MB - 18MB)</label>
            <input id="inputFile" type="file" accept=".pdf" class="mt-2 w-full text-sm" />
            <div class="text-xs text-gray-400 mt-1">Ou cole o link do Curso Online ou Aplicativo.</div>

            <div class="mt-4">
              <label class="block text-sm text-gray-300">Link (Curso Online / Aplicativo)</label>
              <input id="inputLink" type="text" placeholder="https://link-para-curso-ou-app" class="mt-2 w-full p-2 bg-gray-800 rounded text-sm"/>
            </div>

            <div id="filePreview" class="text-sm text-gray-300 mt-2"></div>
          </div>

          <div id="step3" class="hidden">
            <h4 class="text-md font-semibold text-blue-300">Verifica√ß√£o</h4>
            <div id="verifyList" class="mt-2 space-y-2 text-sm"></div>
            <div class="text-xs text-gray-400 mt-2">Se tiver pend√™ncias, volte √† etapa indicada e corrija.</div>
          </div>

          <div class="flex justify-between items-center mt-4 sticky bottom-0 bg-gray-900 pt-4">
            <button id="prevBtn" class="px-3 py-2 bg-gray-700 rounded hover:bg-gray-600 hidden">Voltar</button>
            <div class="flex gap-2">
              <button id="nextBtn" class="px-3 py-2 bg-blue-600 rounded hover:bg-blue-700">Avan√ßar</button>
              <button id="finishBtn" class="px-3 py-2 bg-green-600 rounded hover:bg-green-700 hidden">Finalizar</button>
            </div>
          </div>
        </div>

        <!-- right: preview area -->
        <div class="space-y-4">
          <div class="text-sm text-gray-400">Visualiza√ß√£o</div>
          <div class="bg-gray-900 p-4 rounded-lg border-l-4 border-blue-500">
            <div id="cardImagePreview" class="h-48 bg-gray-800 rounded flex items-center justify-center text-gray-500">Sem imagem</div>
            <div class="mt-3">
              <div id="cardNamePreview" class="text-lg font-bold">Nome do produto</div>
              <div id="cardDescPreview" class="text-sm text-gray-400 mt-1 line-clamp-3">Descri√ß√£o breve...</div>
              <div id="cardPricePreview" class="text-blue-300 font-semibold mt-3">0 MZN</div>
              <div id="cardStatusPreview" class="text-xs text-yellow-300 mt-1">Pendente</div>
            </div>
          </div>

          <div class="text-sm text-gray-400">
            <p><strong>Observa√ß√µes:</strong></p>
            <ul class="list-disc ml-5 mt-2">
              <li>Etapa 1 ‚Äî informa√ß√µes e imagem</li>
              <li>Etapa 2 ‚Äî arquivo (PDF) ou link</li>
              <li>Etapa 3 ‚Äî verifica√ß√£o</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SUCCESS overlay -->
  <div id="successOverlay" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-60">
    <div class="bg-gray-900 p-6 rounded-2xl border border-blue-600 w-96 text-center relative">
      <button id="successClose" class="absolute right-4 top-3 text-gray-300 text-xl">‚úï</button>
      <div class="text-4xl">üì¶‚úÖÔ∏è</div>
      <h3 class="text-xl font-bold text-blue-300 mt-3">Produto criado com sucesso</h3>
      <p class="text-gray-300 mt-3 text-sm leading-relaxed">
        O tempo de espera para revis√£o pelo suporte DIGIVEND √© de 30 minutos no m√≠nimo.
        Se aprovado, o status mudar√° de <strong>Pendente</strong> para <strong>Ativo</strong>.
      </p>
    </div>
  </div>

<script>
/* Encapsular tudo em DOMContentLoaded para garantir sele√ß√£o correta dos elementos */
document.addEventListener('DOMContentLoaded', () => {
  /* ========== Helpers e storage ========== */
  const PROD_KEY = 'digivend_produtos';
  const NOTIF_KEY = 'digivend_notificacoes_vendedor';
  const getProducts = () => JSON.parse(localStorage.getItem(PROD_KEY) || '[]');
  const saveProducts = arr => { localStorage.setItem(PROD_KEY, JSON.stringify(arr)); renderProductGrid(); };
  const getNotifs = () => JSON.parse(localStorage.getItem(NOTIF_KEY) || '[]');
  const saveNotifs = arr => localStorage.setItem(NOTIF_KEY, JSON.stringify(arr));

  /* ========== Sidebar / Header ========== */
  const sidebar = document.getElementById('sidebar');
  const openSidebar = document.getElementById('open-sidebar');
  const closeSidebar = document.getElementById('close-sidebar');
  openSidebar.addEventListener('click', () => sidebar.classList.remove('-translate-x-full'));
  closeSidebar.addEventListener('click', () => sidebar.classList.add('-translate-x-full'));
  document.querySelectorAll('.menu-item').forEach(el => el.addEventListener('click', () => sidebar.classList.add('-translate-x-full')));

  /* Profile menu */
  const profileBtn = document.getElementById('profileBtn');
  const profileMenu = document.getElementById('profileMenu');
  profileBtn.addEventListener('click', (e) => { e.stopPropagation(); profileMenu.classList.toggle('hidden'); });
  window.addEventListener('click', () => profileMenu.classList.add('hidden'));
  document.getElementById('logoutBtn').addEventListener('click', () => { localStorage.removeItem('usuarioAtual'); location.href = 'login.html'; });

  /* ========== Notifications (bell) ========== */
  const bellBtn = document.getElementById('bellBtn');
  const bellDropdown = document.getElementById('bellDropdown');
  const bellItems = document.getElementById('bellItems');
  const bellCountEl = document.getElementById('bellCount');

  function updateBell() {
    const unread = getNotifs().filter(n => !n.read).length;
    bellCountEl.textContent = unread;
    bellCountEl.classList.toggle('hidden', unread === 0);
  }
  function renderBell() {
    const arr = getNotifs().slice().sort((a,b)=> new Date(b.datetime) - new Date(a.datetime));
    bellItems.innerHTML = '';
    if (!arr.length) { bellItems.innerHTML = '<div class="p-3 text-gray-400">Sem notifica√ß√µes</div>'; return; }
    arr.forEach(n => {
      const div = document.createElement('div');
      div.className = `p-3 rounded-md flex justify-between items-start cursor-pointer ${n.read ? 'bg-gray-850' : 'bg-gray-800 border-l-4 border-blue-500 shadow-md'}`;
      div.innerHTML = `<div><div class="text-sm font-semibold text-white">${n.subject}</div><div class="text-xs text-gray-400 mt-1">${n.name} ‚Ä¢ ${new Date(n.datetime).toLocaleString()}</div></div><div class="text-gray-400 text-xs pl-2">‚Ä∫</div>`;
      div.addEventListener('click', () => window.location.href = `notificacoes.html?id=${n.id}`);
      bellItems.appendChild(div);
    });
  }
  bellBtn.addEventListener('click', (e) => { e.stopPropagation(); renderBell(); bellDropdown.classList.toggle('hidden'); updateBell(); });

  /* close bell when click outside */
  window.addEventListener('click', (e) => {
    if (!bellDropdown.contains(e.target) && !bellBtn.contains(e.target)) bellDropdown.classList.add('hidden');
  });

  /* ========== Grid rendering ========== */
  const productGrid = document.getElementById('productGrid');
  function escapeHtml(s){ const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

  function renderProductGrid(searchText = '', category = 'Todos') {
    const arr = getProducts();
    const filtered = arr.filter(p => {
      const t = (searchText||'').trim().toLowerCase();
      const matchesText = !t ? true : ((p.nome||'').toLowerCase().includes(t) || (p.descricao||'').toLowerCase().includes(t));
      const matchesCat = category === 'Todos' ? true : (p.categoria === category);
      return matchesText && matchesCat;
    });

    productGrid.innerHTML = '';
    if (!filtered.length) {
      productGrid.innerHTML = '<div class="col-span-full text-gray-400">Nenhum produto encontrado.</div>';
      return;
    }

    filtered.forEach(p => {
      const card = document.createElement('div');
      card.className = 'bg-gray-900 rounded-2xl overflow-hidden shadow-lg flex flex-col';
      card.innerHTML = `
        <div class="h-44 bg-cover bg-center" style="background-image: url('${p.imageData || ''}'); background-color:#0b1220"></div>
        <div class="p-4 flex-1 flex flex-col">
          <div class="flex justify-between">
            <div>
              <h3 class="text-lg font-semibold text-blue-300">${escapeHtml(p.nome)}</h3>
              <p class="text-xs text-gray-400 mt-1 line-clamp-2">${escapeHtml(p.descricao)}</p>
            </div>
            <div class="text-right">
              <div class="text-blue-300 font-bold">${p.finalPrice} MZN</div>
              <div class="text-xs mt-1 ${p.status==='Pendente' ? 'text-yellow-300' : p.status==='Ativo' ? 'text-green-400' : 'text-gray-400'}">${p.status}</div>
            </div>
          </div>
        </div>
        <div class="p-3 flex items-center gap-2 border-t border-gray-800 bg-gray-900">
          <button class="copy-btn px-3 py-1 bg-gray-800 rounded text-sm" data-id="${p.id}">üìã Copiar link</button>
          <button class="edit-btn px-3 py-1 bg-blue-600 rounded text-sm text-white" data-id="${p.id}">‚úèÔ∏è Editar</button>
          <button class="del-btn px-3 py-1 bg-red-600 rounded text-sm" data-id="${p.id}">üóëÔ∏è Remover</button>
        </div>
      `;
      productGrid.appendChild(card);
    });

    // attach listeners
    document.querySelectorAll('.copy-btn').forEach(b => b.addEventListener('click', (e) => {
      const id = e.currentTarget.dataset.id;
      const url = `${location.origin}${location.pathname.replace(/[^\/]*$/,'')}produto.html?id=${id}`;
      navigator.clipboard?.writeText(url).then(()=> alert('Link copiado')).catch(()=> prompt('Copie o link:', url));
    }));
    document.querySelectorAll('.del-btn').forEach(b => b.addEventListener('click', (e) => {
      const id = e.currentTarget.dataset.id;
      if (confirm('Remover este produto?')) removeProductById(id);
    }));
    document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', (e) => {
      const id = e.currentTarget.dataset.id;
      openEditorById(id);
    }));
  }

  function removeProductById(id) {
    const arr = getProducts().filter(p => String(p.id) !== String(id));
    saveProducts(arr);
    renderProductGrid(document.getElementById('searchInput').value, currentCategoryFilter);
  }

  /* ========== Category dropdown (toggle + actions) ========== */
  const filterToggle = document.getElementById('filterToggle');
  const catDropdown = document.getElementById('catDropdown');
  const catButtons = Array.from(document.querySelectorAll('.catOpt'));
  let currentCategoryFilter = 'Todos';

  filterToggle.addEventListener('click', (e) => { e.stopPropagation(); catDropdown.classList.toggle('hidden'); });
  catButtons.forEach(b => b.addEventListener('click', () => {
    currentCategoryFilter = b.dataset.cat;
    catDropdown.classList.add('hidden');
    renderProductGrid(document.getElementById('searchInput').value, currentCategoryFilter);
  }));
  window.addEventListener('click', () => catDropdown.classList.add('hidden'));

  /* ========== Modal create/edit logic ========== */
  const productModal = document.getElementById('productModal');
  const createBtn = document.getElementById('createProductBtn');
  const modalClose = document.getElementById('modalClose');
  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');
  const step3 = document.getElementById('step3');
  const stepIndicator = document.getElementById('stepIndicator');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const finishBtn = document.getElementById('finishBtn');

  const inputImage = document.getElementById('inputImage');
  const cardImagePreview = document.getElementById('cardImagePreview');
  const inputName = document.getElementById('inputName');
  const inputPrice = document.getElementById('inputPrice');
  const inputDiscount = document.getElementById('inputDiscount');
  const inputCoupon = document.getElementById('inputCoupon');
  const finalPriceEl = document.getElementById('finalPrice');
  const inputDesc = document.getElementById('inputDesc');
  const descCount = document.getElementById('descCount');
  const inputCategory = document.getElementById('inputCategory');
  const inputType = document.getElementById('inputType');
  const allowAff = document.getElementById('allowAff');
  const affSection = document.getElementById('affSection');
  const affCommission = document.getElementById('affCommission');
  const affValue = document.getElementById('affValue');
  const affLink = document.getElementById('affLink');
  const inputFile = document.getElementById('inputFile');
  const inputLink = document.getElementById('inputLink');
  const filePreview = document.getElementById('filePreview');
  const verifyList = document.getElementById('verifyList');

  let currentStep = 1;
  let currentImageData = null;
  let currentFileData = null;
  let editingId = null;

  function showModal() { productModal.classList.remove('hidden'); resetModal(); goToStep(1); }
  function hideModal() { productModal.classList.add('hidden'); }

  createBtn.addEventListener('click', showModal);
  modalClose.addEventListener('click', hideModal);

  function resetModal() {
    currentImageData = null; currentFileData = null; editingId = null;
    inputImage.value = ''; cardImagePreview.innerHTML = 'Sem imagem';
    inputName.value = ''; inputPrice.value = ''; inputDiscount.value = '0'; inputCoupon.value = ''; finalPriceEl.textContent = '0 MZN';
    inputDesc.value = ''; descCount.textContent = '0';
    inputCategory.value = 'Empreender'; inputType.value = 'Ebook'; allowAff.checked = false; affSection.classList.add('hidden');
    affCommission.value = 10; affValue.textContent = '0 MZN'; affLink.value = '';
    inputFile.value = ''; inputLink.value = ''; filePreview.textContent = '';
    step1.classList.remove('hidden'); step2.classList.add('hidden'); step3.classList.add('hidden');
    prevBtn.classList.add('hidden'); nextBtn.classList.remove('hidden'); finishBtn.classList.add('hidden');
    document.getElementById('modalTitle').textContent = 'Criar Produto';
    stepIndicator.textContent = 'Etapa 1 de 3';
  }

  function goToStep(n) {
    currentStep = n;
    step1.classList.toggle('hidden', n !== 1);
    step2.classList.toggle('hidden', n !== 2);
    step3.classList.toggle('hidden', n !== 3);
    prevBtn.classList.toggle('hidden', n === 1);
    nextBtn.classList.toggle('hidden', n === 3);
    finishBtn.classList.toggle('hidden', n !== 3);
    stepIndicator.textContent = `Etapa ${n} de 3`;
    renderPreview();
    if (n === 3) runVerification();
  }

  prevBtn.addEventListener('click', () => goToStep(Math.max(1, currentStep - 1)));
  nextBtn.addEventListener('click', () => {
    if (currentStep === 1) {
      if (!currentImageData) { alert('Carregue a imagem do produto.'); return; }
      if (!inputName.value.trim()) { alert('Preencha o nome.'); return; }
      if (inputDesc.value.trim().length < 150) { alert('Descri√ß√£o precisa ter pelo menos 150 caracteres.'); return; }
      goToStep(2);
    } else if (currentStep === 2) {
      const tipo = inputType.value;
      if (tipo === 'Ebook') {
        if (!(currentFileData && currentFileData.fileData)) { alert('Carregue o PDF do Ebook (3MB - 18MB).'); return; }
      } else {
        if (!inputLink.value.trim()) { alert('Cole o link do Curso ou Aplicativo.'); return; }
      }
      goToStep(3);
    }
  });

  finishBtn.addEventListener('click', () => {
    const ver = runVerification();
    if (!ver.ok) { alert('Verifica√ß√£o falhou ‚Äî corrija os itens pendentes.'); return; }

    const id = editingId || String(Date.now());
    const nome = inputName.value.trim();
    const preco = Number(inputPrice.value) || 0;
    const desconto = Number(inputDiscount.value) || 0;
    const coupon = inputCoupon.value.trim();
    const finalPrice = computeFinalPriceValue();
    const descricao = inputDesc.value.trim();
    const categoria = inputCategory.value;
    const tipo = inputType.value;
    const allowAffBool = allowAff.checked;
    const affComm = allowAffBool ? Number(affCommission.value) || 0 : 0;
    const affVal = allowAffBool ? Math.round((finalPrice * affComm) / 100) : 0;
    const affL = affLink.value.trim() || '';
    const status = 'Pendente';
    const createdAt = new Date().toISOString();

    const product = {
      id, nome, preco, desconto, coupon, finalPrice, descricao, categoria, tipo,
      allowAff: allowAffBool, affCommission: affComm, affValue: affVal, affLink: affL,
      imageData: currentImageData, fileData: currentFileData?.fileData || null,
      fileName: currentFileData?.fileName || null, fileSize: currentFileData?.fileSize || null,
      fileType: currentFileData?.fileType || null, fileLink: inputLink.value.trim() || null,
      status, createdAt
    };

    const arr = getProducts();
    if (editingId) {
      const idx = arr.findIndex(x => x.id === editingId);
      if (idx >= 0) arr[idx] = product; else arr.push(product);
    } else arr.push(product);

    saveProducts(arr);
    hideModal();
    document.getElementById('successOverlay').classList.remove('hidden');
    setTimeout(() => {
      document.getElementById('successOverlay').classList.add('hidden');
      renderProductGrid(document.getElementById('searchInput').value, currentCategoryFilter);
    }, 3500);
  });

  /* description counter & preview */
  inputDesc.addEventListener('input', () => {
    descCount.textContent = inputDesc.value.length;
    document.getElementById('cardDescPreview').textContent = inputDesc.value.slice(0, 200);
  });

  /* image upload */
  inputImage.addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => { currentImageData = reader.result; cardImagePreview.innerHTML = `<img src="${currentImageData}" class="w-full h-full object-cover" />`; renderPreview(); };
    reader.readAsDataURL(f);
  });

  /* price compute */
  inputPrice.addEventListener('input', computeFinalPrice);
  inputDiscount.addEventListener('input', computeFinalPrice);
  function computeFinalPrice() { finalPriceEl.textContent = computeFinalPriceValue() + ' MZN'; document.getElementById('cardPricePreview').textContent = computeFinalPriceValue() + ' MZN'; computeAffValue(); }
  function computeFinalPriceValue() { const p = Number(inputPrice.value) || 0; const d = Number(inputDiscount.value) || 0; return +(p * (1 - d / 100)).toFixed(2); }

  /* affiliates */
  allowAff.addEventListener('change', () => { if (allowAff.checked) affSection.classList.remove('hidden'); else affSection.classList.add('hidden'); computeAffValue(); });
  affCommission.addEventListener('input', computeAffValue);
  function computeAffValue() { const fp = computeFinalPriceValue(); const comm = Number(affCommission.value) || 0; affValue.textContent = Math.round((fp * comm) / 100) + ' MZN'; }

  /* file upload step2 */
  inputFile.addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) { filePreview.textContent = ''; currentFileData = null; return; }
    const min = 3 * 1024 * 1024, max = 18 * 1024 * 1024;
    if (f.size < min) { alert('Arquivo muito pequeno (m√≠n 3MB)'); inputFile.value = ''; return; }
    if (f.size > max) { alert('Arquivo muito grande (m√°x 18MB)'); inputFile.value = ''; return; }
    const reader = new FileReader();
    reader.onload = () => { currentFileData = { fileData: reader.result, fileName: f.name, fileSize: f.size, fileType: f.type }; filePreview.textContent = `${f.name} (${Math.round(f.size / 1024)} KB)`; };
    reader.readAsDataURL(f);
  });
  inputLink.addEventListener('input', () => { if (inputLink.value.trim() !== '') { inputFile.value = ''; currentFileData = null; filePreview.textContent = 'Usando link'; } });

  function runVerification() {
    const checks = [];
    const nameOk = !!inputName.value.trim();
    const imgOk = !!currentImageData;
    const descOk = inputDesc.value.trim().length >= 150;
    checks.push({ msg: 'Nome preenchido', ok: nameOk });
    checks.push({ msg: 'Imagem enviada', ok: imgOk });
    if (inputType.value === 'Ebook') checks.push({ msg: 'Arquivo PDF enviado (3MB-18MB)', ok: !!(currentFileData && currentFileData.fileData) });
    else checks.push({ msg: 'Link do curso/aplicativo fornecido', ok: !!inputLink.value.trim() });
    checks.push({ msg: 'Descri√ß√£o >=150 caracteres', ok: descOk });
    verifyList.innerHTML = '';
    let okAll = true;
    checks.forEach(c => {
      const div = document.createElement('div');
      div.className = `p-3 rounded ${c.ok ? 'bg-gray-850' : 'bg-gray-800 border-l-4 border-blue-500 shadow-md'}`;
      div.innerHTML = `<div class="flex justify-between"><div>${c.msg}</div><div class="${c.ok ? 'text-green-400' : 'text-yellow-300'}">${c.ok ? 'OK' : 'Pendente'}</div></div>`;
      verifyList.appendChild(div);
      if (!c.ok) okAll = false;
    });
    return { ok: okAll, checks };
  }

  function renderPreview() {
    document.getElementById('cardNamePreview').textContent = inputName.value || 'Nome do produto';
    document.getElementById('cardDescPreview').textContent = inputDesc.value ? inputDesc.value.slice(0, 200) : 'Descri√ß√£o breve...';
    document.getElementById('cardPricePreview').textContent = computeFinalPriceValue() + ' MZN';
    document.getElementById('cardStatusPreview').textContent = 'Pendente';
  }

  /* edit flow */
  function openEditorById(id) {
    const p = getProducts().find(x => String(x.id) === String(id));
    if (!p) return;
    editingId = p.id;
    showModal();
    if (p.imageData) { currentImageData = p.imageData; cardImagePreview.innerHTML = `<img src="${currentImageData}" class="w-full h-full object-cover"/>`; }
    inputName.value = p.nome; inputPrice.value = p.preco; inputDiscount.value = p.desconto || 0; inputCoupon.value = p.coupon || '';
    inputDesc.value = p.descricao; descCount.textContent = inputDesc.value.length;
    inputCategory.value = p.categoria || 'Outros'; inputType.value = p.tipo || 'Ebook';
    if (p.allowAff) { allowAff.checked = true; affSection.classList.remove('hidden'); affCommission.value = p.affCommission || 0; affLink.value = p.affLink || ''; computeAffValue(); }
    if (p.fileData) { currentFileData = { fileData: p.fileData, fileName: p.fileName, fileSize: p.fileSize, fileType: p.fileType }; filePreview.textContent = `${p.fileName}`; }
    if (p.fileLink) inputLink.value = p.fileLink;
    computeFinalPrice();
    renderPreview();
  }
  window.openEditorById = openEditorById;

  /* search input */
  document.getElementById('searchInput').addEventListener('input', (e) => renderProductGrid(e.target.value, currentCategoryFilter));

  /* initial render */
  renderProductGrid('', 'Todos');
  updateBell();
  renderBell();

  /* success overlay close */
  document.getElementById('successClose').addEventListener('click', () => document.getElementById('successOverlay').classList.add('hidden'));

}); /* end DOMContentLoaded */
</script>

<style>
  .bg-gray-850 { background: #0f1724; border-radius:8px; }
  .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  html, body { overflow-x: hidden; } /* prevent horizontal scroll */
</style>
</body>
</html>
