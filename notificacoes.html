<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NotificaÃ§Ãµes | DIGIVEND</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-950 text-white min-h-screen">

  <main class="max-w-3xl mx-auto p-6">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-blue-400">ðŸ“¬ NotificaÃ§Ãµes</h1>
      <a href="dashboard_vendedor.html" class="text-blue-300 hover:underline">â¬… Voltar ao Dashboard</a>
    </div>

    <div id="list" class="space-y-3 mb-8"></div>

    <!-- area onde abrimos o detalhe da notificaÃ§Ã£o -->
    <div id="openArea"></div>
  </main>

<script>
  const NOTIF_KEY = "digivend_notificacoes_vendedor";

  function getNotifs(){ return JSON.parse(localStorage.getItem(NOTIF_KEY)) || []; }
  function saveNotifs(arr){ localStorage.setItem(NOTIF_KEY, JSON.stringify(arr)); }

  // parse ?id=
  const params = new URLSearchParams(location.search);
  const openId = params.get("id") ? parseInt(params.get("id")) : null;

  const list = document.getElementById("list");
  const openArea = document.getElementById("openArea");

  function renderList(){
    const nots = getNotifs().sort((a,b)=> new Date(b.datetime)-new Date(a.datetime));
    list.innerHTML = "";
    if (nots.length === 0) {
      list.innerHTML = '<p class="text-gray-400">Nenhuma notificaÃ§Ã£o.</p>';
      return;
    }
    nots.forEach(n=>{
      const row = document.createElement("div");
      row.className = "p-3 rounded-lg flex justify-between items-center " + (n.read ? "bg-gray-850" : "bg-gray-800 border-l-4 border-blue-500 shadow-md");
      row.innerHTML = `
        <div>
          <div class="font-semibold">${escapeHtml(n.name)} <span class="text-xs text-gray-400">â€¢ ${new Date(n.datetime).toLocaleString()}</span></div>
          <div class="text-sm text-gray-300 mt-1">${escapeHtml(n.subject)}</div>
        </div>
        <div class="flex gap-2 items-center">
          <button class="text-sm text-blue-300" data-open="${n.id}">Abrir</button>
          <button class="text-sm text-gray-300" data-delete="${n.id}">âœ•</button>
        </div>`;
      list.appendChild(row);
    });

    // attach events
    list.querySelectorAll("[data-open]").forEach(b => b.addEventListener("click", ()=> openNotificacao(parseInt(b.getAttribute("data-open"))) ));
    list.querySelectorAll("[data-delete]").forEach(b => b.addEventListener("click", ()=> {
      const id = parseInt(b.getAttribute("data-delete"));
      // remove notification (mark read/remove)
      removeNotificacao(id);
    }));
  }

  function openNotificacao(id){
    const nots = getNotifs();
    const n = nots.find(x => x.id === id);
    if (!n) return;
    // render detalhe no centro (card)
    openArea.innerHTML = `
      <div class="bg-gray-900 p-6 rounded-xl shadow-2xl border-l-4 border-blue-500">
        <div class="flex justify-between items-start">
          <div>
            <div class="text-sm text-blue-300 font-semibold">${escapeHtml(n.name)}</div>
            <div class="text-xs text-gray-400">${new Date(n.datetime).toLocaleString()}</div>
            <div class="text-xl font-bold mt-3">${escapeHtml(n.subject)}</div>
          </div>
          <div>
            <button id="closeDetail" class="text-gray-300 text-xl">âœ•</button>
          </div>
        </div>
        <div class="mt-4 text-gray-200 leading-relaxed">${escapeHtml(n.message).replace(/\n/g,'<br/>')}</div>
      </div>
    `;
    // mark as read (but keep in list) so it loses glow; when user closes we will remove it from list (per spec)
    markAsRead(id);

    // close handler -> remove from list (so disappears from bell)
    document.getElementById("closeDetail").addEventListener("click", ()=>{
      removeNotificacao(id);
      // remove visually
      const el = document.getElementById("openArea");
      el.innerHTML = "";
      renderList();
    });
    // scroll to detail
    openArea.scrollIntoView({ behavior: "smooth", block: "center" });
  }

  function markAsRead(id) {
    const nots = getNotifs().map(n => n.id===id ? {...n, read:true} : n );
    saveNotifs(nots);
  }

  function removeNotificacao(id){
    const nots = getNotifs().filter(n => n.id !== id);
    saveNotifs(nots);
    renderList();
    // update bell count on dashboard (dashboard reads same localStorage on load)
  }

  function escapeHtml(s){
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  renderList();

  // se veio ?id=NN abrir automaticamente
  if (openId) {
    setTimeout(()=> openNotificacao(openId), 200);
  }
</script>

<style>
.bg-gray-850 { background:#0f1724; border-radius:8px; }
</style>
</body>
</html>

