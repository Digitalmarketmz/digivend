<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Adicionar Produto ‚Äî DIGIVEND</title>
<style>
  :root{
    --bg:#000;
    --panel:#0f1724;
    --muted:#9ca3af;
    --accent:#0ea5e9;
    --danger:#ef4444;
    --card:#0b1220;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Arial,Helvetica,sans-serif;overflow-x:hidden}
  /* Topbar / Sidebar like dashboard_vendedor */
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:#0b1220;border-bottom:1px solid #071019;position:sticky;top:0;z-index:30}
  .topbar .left{display:flex;align-items:center;gap:12px}
  .menu-btn{font-size:20px;cursor:pointer}
  .logo{font-weight:700;color:var(--accent);font-size:20px;position:absolute;left:50%;transform:translateX(-50%)}
  .right-actions{display:flex;gap:12px;align-items:center}
  .icon-btn{background:transparent;border:0;color:#fff;font-size:20px;cursor:pointer;position:relative}
  .badge{position:absolute;top:-6px;right:-6px;background:#ef4444;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px}

  /* sidebar */
  .sidebar{position:fixed;left:0;top:0;height:100%;width:260px;background:#071021;transform:translateX(-120%);transition:transform .25s ease;z-index:40;padding:18px}
  .sidebar.open{transform:translateX(0)}
  .sidebar h3{color:var(--accent);margin:0 0 16px 0}
  .sidebar nav a{display:block;color:#cbd5e1;padding:10px;border-radius:8px;text-decoration:none;margin-bottom:6px}
  .sidebar nav a:hover{background:#071a2a;color:#fff}

  /* page container */
  .container{max-width:1200px;margin:22px auto;padding:0 16px}
  .search-row{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;margin-bottom:12px}
  .search-row input[type="text"]{min-width:260px;width:48%;max-width:580px;padding:10px;border-radius:8px;border:0;background:#0b1220;color:#fff}
  .search-row .left{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#00121a;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid #133544;color:#fff}

  /* products grid */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  @media(max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}.search-row input[type="text"]{width:70%}}
  @media(max-width:640px){.grid{grid-template-columns:1fr}.search-row input[type="text"]{width:100%}}

  .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 4px 20px rgba(2,6,23,.6);display:flex;flex-direction:column;gap:8px}
  .card img{width:100%;height:140px;object-fit:cover;border-radius:8px}
  .card h4{margin:0;color:var(--accent);font-size:16px}
  .meta{font-size:13px;color:var(--muted)}
  .status-pill{display:inline-block;padding:6px 8px;border-radius:999px;font-weight:600;font-size:12px}
  .status-pendente{background:#f59e0b;color:#0b1220}
  .status-ativo{background:#10b981;color:#042017}
  .status-inativo{background:#6b7280;color:#0b1220}

  .card-actions{display:flex;gap:8px;margin-top:8px}
  .small-btn{flex:1;padding:8px;border-radius:8px;border:0;cursor:pointer;font-size:13px}
  .small-btn.copy{background:#e6f6fb;color:#00303a}
  .small-btn.edit{background:#0ea5e9;color:#00121a}
  .small-btn.delete{background:#ef4444;color:#fff}

  /* form modal / panel */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:80;padding:18px}
  .modal.open{display:flex}
  .panel{background:#07121a;border-radius:12px;padding:18px;width:100%;max-width:720px;max-height:90vh;overflow:auto;border:1px solid #083046}
  .panel h2{margin:0 0 12px 0;color:var(--accent)}
  .steps{display:flex;gap:8px;margin-bottom:12px}
  .progress{height:8px;background:#071a24;border-radius:8px;overflow:hidden;margin-bottom:12px}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#60a5fa);width:33%;transition:width .35s}

  .row{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:180px}
  label{display:block;margin-bottom:6px;color:#93c5fd;font-weight:600}
  input[type="text"],input[type="number"],select,textarea{width:100%;padding:10px;border-radius:8px;border:0;background:#071826;color:#fff}
  textarea{min-height:120px;resize:vertical}
  .field-error{outline:2px solid rgba(239,68,68,.9);border-radius:8px}
  .helper{font-size:13px;color:#94a3b8;margin-top:6px}

  .form-actions{display:flex;gap:8px;justify-content:space-between;margin-top:12px}
  .muted{color:#94a3b8;font-size:13px}

  /* success overlay */
  .success-box{position:fixed;left:50%;top:25%;transform:translateX(-50%);background:#071a24;padding:18px;border-radius:12px;border:1px solid #083046;display:none;z-index:90}
  .success-box.open{display:block}
  .close-x{cursor:pointer;color:var(--accent);float:right;font-weight:700}
</style>
</head>
<body>

  <!-- Topbar -->
  <div class="topbar">
    <div class="left">
      <div id="menuBtn" class="menu-btn">‚ò∞</div>
    </div>

    <div class="logo">DIGIVEND</div>

    <div class="right-actions">
      <button id="bellBtn" class="icon-btn" aria-label="Notifica√ß√µes">üîî<span id="bellCount" class="badge" style="display:none">0</span></button>
      <button id="profileBtn" class="icon-btn" aria-label="Perfil">üë§</button>
    </div>
  </div>

  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar" aria-hidden="true">
    <h3>DIGIVEND</h3>
    <nav>
      <a href="dashboard_vendedor.html">üè† Dashboard</a>
      <a href="meus_produtos.html">üì¶ Meus Produtos</a>
      <a href="notificacoes.html">‚úâÔ∏è Notifica√ß√µes</a>
      <a href="marketplace.html">üõí Marketplace / Loja</a>
      <a href="configuracoes.html">‚öôÔ∏è Configura√ß√µes</a>
      <a href="index.html">üö™ Sair</a>
    </nav>
  </aside>

  <!-- Main -->
  <div class="container">
    <div class="search-row">
      <div class="left">
        <input id="searchInput" type="text" placeholder="Pesquisar produto..." />
        <select id="categorySelect"><option value="">Todas categorias</option><option>Empreender</option><option>Neg√≥cios</option><option>Sa√∫de</option><option>Educa√ß√£o</option><option>Outros</option></select>
      </div>
      <div>
        <button id="createBtn" class="btn">+ Criar</button>
      </div>
    </div>

    <div id="productsGrid" class="grid" aria-live="polite"></div>
  </div>

  <!-- Modal (form) -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="panel">
      <h2>Criar / Editar Produto</h2>
      <div class="progress"><i id="progFill"></i></div>

      <!-- STEP 1 -->
      <div id="step1">
        <label>Foto do Produto</label>
        <input id="field_image" type="file" accept="image/*" />
        <div class="row">
          <div class="col">
            <label>Nome</label>
            <input id="field_name" type="text" />
          </div>
          <div class="col">
            <label>Autor / Fabricante</label>
            <input id="field_author" type="text" />
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div class="col">
            <label>Pre√ßo (MT) ‚Äî m√≠nimo 99</label>
            <input id="field_price" type="number" min="0" />
            <div id="priceHelp" class="helper muted">Pre√ßo m√≠nimo: 99 MT</div>
          </div>
          <div class="col">
            <label>Desconto (%)</label>
            <input id="field_discount" type="number" min="0" max="90" />
            <div id="discountHelp" class="helper muted">Descontos s√≥ para produtos a partir de 199 MT</div>
          </div>
        </div>

        <label style="margin-top:8px">Cupom</label>
        <input id="field_coupon" type="text" />

        <label style="margin-top:8px">Descri√ß√£o (m√≠n 150 caracteres)</label>
        <textarea id="field_description"></textarea>
        <div class="helper" id="descCount">0 / 150</div>

        <div class="row" style="margin-top:12px">
          <div class="col">
            <label>Categoria</label>
            <select id="field_category"><option value="">Selecione...</option><option>Empreender</option><option>Neg√≥cios</option><option>Sa√∫de</option><option>Educa√ß√£o</option><option>Outros</option></select>
          </div>
          <div class="col">
            <label>Tipo</label>
            <select id="field_type"><option value="">Selecione...</option><option value="Ebook">Ebook</option><option value="Curso">Curso Online</option><option value="App">Aplicativo</option></select>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Permitir Afiliados?</label>
          <select id="field_affiliate"><option value="no">N√£o</option><option value="yes">Sim</option></select>
        </div>

        <div id="affiliateBox" style="display:none;margin-top:10px;border-left:4px solid #063a49;padding-left:10px">
          <label>Comiss√£o (%)</label>
          <input id="field_commission" type="number" min="1" max="90" />
          <label style="margin-top:8px">Valor ao afiliado (MT)</label>
          <input id="field_affvalue" type="text" readonly />
          <label style="margin-top:8px">Link do afiliado</label>
          <input id="field_afflink" type="text" />
        </div>

        <div class="form-actions" style="margin-top:14px">
          <button id="s1_next" class="btn">Avan√ßar ‚Üí</button>
          <button id="s1_cancel" class="btn ghost" style="background:transparent;border:1px solid #083046;color:#9fbcd6">Cancelar</button>
        </div>
      </div>

      <!-- STEP 2 -->
      <div id="step2" style="display:none">
        <label id="step2Label">Envio do produto / link</label>
        <div id="step2Area" style="margin-top:8px"></div>
        <div class="form-actions">
          <button id="s2_back" class="btn ghost" style="background:transparent;border:1px solid #083046;color:#9fbcd6">‚Üê Voltar</button>
          <button id="s2_next" class="btn">Avan√ßar ‚Üí</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div id="step3" style="display:none">
        <div class="verificacao">
          <h3>Verifica√ß√£o autom√°tica</h3>
          <div id="verifyList" style="margin-top:12px"></div>
          <div class="helper" style="margin-top:10px">Se algo estiver pendente, voc√™ poder√° voltar para corrigir.</div>
          <div style="margin-top:12px" class="form-actions">
            <button id="s3_back" class="btn ghost" style="background:transparent;border:1px solid #083046;color:#9fbcd6">‚Üê Voltar</button>
            <button id="s3_finish" class="btn" disabled>Finalizar</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- success box -->
  <div id="successBox" class="success-box">
    <div class="close-x" id="closeSuccess">‚úñ</div>
    <div style="font-size:28px">üì¶‚úÖ</div>
    <div style="margin-top:8px;font-weight:700">Produto criado com sucesso</div>
    <div class="muted" style="margin-top:8px;font-size:13px">
      O tempo de revis√£o m√≠nimo √© 30 minutos. Ap√≥s aprova√ß√£o o produto ficar√° Ativo.
    </div>
  </div>

<script>
/* ---------- Utilities & Storage ---------- */
const LS_KEY = 'digivend_produtos_v2';
function getProducts(){ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }
function saveProducts(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); renderProducts(); }

/* ---------- Sidebar / Topbar ---------- */
const sidebar = document.getElementById('sidebar'), menuBtn = document.getElementById('menuBtn');
menuBtn.onclick = ()=> sidebar.classList.toggle('open');
document.getElementById('createBtn').addEventListener('click', openModal);

/* bell/profile UI (placeholders for design parity) */
const bellBtn = document.getElementById('bellBtn'), bellCount = document.getElementById('bellCount');
bellBtn.onclick = ()=> alert('Notifica√ß√µes (placeholder)'); // can be wired to real notifications
document.getElementById('profileBtn').onclick = ()=> alert('Perfil (placeholder)');

/* ---------- Render products grid ---------- */
const productsGrid = document.getElementById('productsGrid');
function renderProducts(){
  const arr = getProducts();
  productsGrid.innerHTML = '';
  if(arr.length===0){ productsGrid.innerHTML = '<div style="grid-column:1/-1;color:#94a3b8;text-align:center;padding:20px">Nenhum produto encontrado.</div>'; return; }
  arr.forEach((p,idx)=>{
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.src = p.imageData || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="250"></svg>';
    const h = document.createElement('h4'); h.textContent = p.name;
    const meta = document.createElement('div'); meta.className='meta'; meta.innerHTML = `${p.type} ‚Ä¢ ${p.category} ‚Ä¢ ${p.author || ''}`;
    const desc = document.createElement('p'); desc.className='meta'; desc.textContent = (p.description||'').slice(0,120) + (p.description && p.description.length>120 ? '...' : '');
    const price = document.createElement('div'); price.innerHTML = `<strong style="color:#c7f9ff">${p.price} MT</strong>`;
    // status
    const statusSpan = document.createElement('div'); statusSpan.style.marginTop='6px';
    const st = document.createElement('span'); st.className='status-pill ' + (p.status==='Pendente' ? 'status-pendente' : p.status==='Ativo' ? 'status-ativo' : 'status-inativo'); st.textContent = p.status;
    statusSpan.appendChild(st);

    // actions
    const actions = document.createElement('div'); actions.className='card-actions';
    const copyBtn = document.createElement('button'); copyBtn.className='small-btn copy'; copyBtn.textContent='üìã Copiar link';
    copyBtn.onclick = ()=> {
      const url = `${location.origin}${location.pathname.replace(/[^\/]*$/,'')}produto.html?id=${encodeURIComponent(p.id)}`;
      navigator.clipboard?.writeText(url).then(()=> alert('Link copiado'));
    };
    const editBtn = document.createElement('button'); editBtn.className='small-btn edit'; editBtn.textContent='‚úèÔ∏è Editar';
    const delBtn = document.createElement('button'); delBtn.className='small-btn delete'; delBtn.textContent='üóëÔ∏è Remover';
    // edit only if not pending
    if(p.status==='Pendente'){ editBtn.disabled=true; editBtn.style.opacity='.5'; editBtn.title='Edi√ß√£o bloqueada enquanto Pendente'; }
    else editBtn.onclick = ()=> openModal(true, idx);
    delBtn.onclick = ()=> { if(confirm('Remover produto?')){ const arr = getProducts(); arr.splice(idx,1); saveProducts(arr); } };

    actions.appendChild(copyBtn); actions.appendChild(editBtn); actions.appendChild(delBtn);

    card.appendChild(img); card.appendChild(h); card.appendChild(meta); card.appendChild(desc); card.appendChild(price); card.appendChild(statusSpan); card.appendChild(actions);
    productsGrid.appendChild(card);
  });
}

/* ---------- Modal & Multi-step Form ---------- */
const modal = document.getElementById('modal');
const progFill = document.getElementById('progFill');
const step1 = document.getElementById('step1'), step2 = document.getElementById('step2'), step3 = document.getElementById('step3');
const s1_next = document.getElementById('s1_next'), s1_cancel = document.getElementById('s1_cancel');
const s2_back = document.getElementById('s2_back'), s2_next = document.getElementById('s2_next');
const s3_back = document.getElementById('s3_back'), s3_finish = document.getElementById('s3_finish');
const field_map = {
  image: document.getElementById('field_image'),
  name: document.getElementById('field_name'),
  author: document.getElementById('field_author'),
  price: document.getElementById('field_price'),
  discount: document.getElementById('field_discount'),
  coupon: document.getElementById('field_coupon'),
  description: document.getElementById('field_description'),
  category: document.getElementById('field_category'),
  type: document.getElementById('field_type'),
  affiliate: document.getElementById('field_affiliate'),
  commission: document.getElementById('field_commission'),
  affvalue: document.getElementById('field_affvalue'),
  afflink: document.getElementById('field_afflink'),
  step2area: document.getElementById('step2Area'),
  step2label: document.getElementById('step2Label'),
  verifyList: document.getElementById('verifyList')
};
let editingIndex = null; // null = create, otherwise index

function openModal(edit=false, idx=null){
  editingIndex = (edit? idx : null);
  resetForm();
  modal.classList.add('open');
  goToStep(1);
  if(edit){
    // populate fields from product
    const prod = getProducts()[idx];
    if(!prod) return;
    // fill
    field_map.name.value = prod.name;
    field_map.author.value = prod.author || '';
    field_map.price.value = prod.price;
    field_map.discount.value = prod.discount || '';
    field_map.coupon.value = prod.coupon || '';
    field_map.description.value = prod.description || '';
    field_map.category.value = prod.category || '';
    field_map.type.value = prod.type || '';
    field_map.affiliate.value = prod.affiliate?'yes':'no';
    if(prod.affiliate){
      document.getElementById('affiliateBox').style.display='block';
      field_map.commission.value = prod.commission || '';
      field_map.affvalue.value = prod.affvalue || '';
      field_map.afflink.value = prod.afflink || '';
    }
    // image data -> store in hidden attr
    field_map.image.dataset.preview = prod.imageData || '';
  }
}

function closeModal(){ modal.classList.remove('open'); editingIndex=null; }

function resetForm(){
  // reset visuals
  progFill.style.width='33%';
  progFill.style.display='block';
  // clear errors & fields unless editing
  ['name','author','price','discount','coupon','description','category','type','commission','affvalue','afflink'].forEach(k=>{ if(!editingIndex) field_map[k].value=''; field_map[k].classList.remove('field-error'); });
  field_map.image.value=''; field_map.image.dataset.preview='';
  document.getElementById('affiliateBox').style.display='none';
  field_map.step2area.innerHTML='';
  field_map.verifyList.innerHTML='';
  // hide steps accordingly
  step1.style.display='block'; step2.style.display='none'; step3.style.display='none';
}

/* field interactions */
field_map.description.addEventListener('input', ()=> {
  document.getElementById('descCount').textContent = `${field_map.description.value.length} / 150`;
});
field_map.affiliate.addEventListener('change', ()=> {
  document.getElementById('affiliateBox').style.display = field_map.affiliate.value === 'yes' ? 'block' : 'none';
});
field_map.commission.addEventListener('input', ()=> {
  const pr = parseFloat(field_map.price.value) || 0;
  const com = parseFloat(field_map.commission.value) || 0;
  field_map.affvalue.value = ((pr * com)/100).toFixed(2);
});
field_map.price.addEventListener('input', ()=>{
  const pr = parseFloat(field_map.price.value)||0;
  const discField = field_map.discount;
  // instant check min price
  if(pr>0 && pr<99){ field_map.price.classList.add('field-error'); document.getElementById('priceHelp').textContent='Pre√ßo m√≠nimo do site: 99 MT'; }
  else { field_map.price.classList.remove('field-error'); document.getElementById('priceHelp').textContent='Pre√ßo m√≠nimo: 99 MT'; }
  // discount rule
  if(pr < 199 && discField.value){ discField.value=''; alert('Desconto s√≥ permitido para produtos a partir de 199 MT'); }
});

/* ---------- Step transitions with per-field validation ---------- */
function markError(el, msg){
  el.classList.add('field-error');
  if(msg) console.warn(msg);
}
function clearError(el){ el.classList.remove('field-error'); }

function validateStep1(){
  // check required fields individually, mark first failing and scroll to it
  const order = ['image','name','author','price','description','category','type'];
  for(const key of order){
    const el = field_map[key];
    if(key==='image'){
      // if no file selected and no preview present (editing allows preview)
      if((!el.files || el.files.length===0) && !el.dataset.preview){ markError(el,'Imagem faltando'); el.scrollIntoView({behavior:'smooth',block:'center'}); return false; }
      else clearError(el);
    } else if(key==='description'){
      if(!el.value || el.value.trim().length < 150){ markError(el,'Descri√ß√£o obrigat√≥ria (m√≠n 150)'); el.scrollIntoView({behavior:'smooth',block:'center'}); return false; }
      else clearError(el);
    } else if(key==='price'){
      const v = parseFloat(el.value)||0;
      if(v < 99){ markError(el,'Pre√ßo m√≠nimo 99'); el.scrollIntoView({behavior:'smooth',block:'center'}); return false; }
      else clearError(el);
    } else {
      if(!el.value || el.value.trim()===''){ markError(el,'Campo obrigat√≥rio'); el.scrollIntoView({behavior:'smooth',block:'center'}); return false; }
      else clearError(el);
    }
  }
  // discount rule
  if( (parseFloat(field_map.price.value)||0) < 199 && field_map.discount.value){ markError(field_map.discount,'Desconto s√≥ p/ >=199'); field_map.discount.scrollIntoView({behavior:'smooth',block:'center'}); return false; }
  return true;
}

s1_next.onclick = (e)=>{
  if(!validateStep1()) return;
  // configure step2 depending on type
  const typ = field_map.type.value;
  field_map.step2area.innerHTML = '';
  if(typ==='Ebook'){
    const inp = document.createElement('input'); inp.type='file'; inp.accept='.pdf'; inp.id='step2_file';
    field_map.step2area.appendChild(inp);
    document.getElementById('step2Label').textContent='Envie o PDF (3MB - 18MB)';
  } else {
    const inp = document.createElement('input'); inp.type='url'; inp.id='step2_link'; inp.placeholder='Cole o link do produto (curso/app)';
    field_map.step2area.appendChild(inp);
    document.getElementById('step2Label').textContent='Cole o link do produto';
  }
  goToStep(2);
};

s1_cancel.onclick = ()=> closeModal();
s2_back.onclick = ()=> goToStep(1);
s2_next.onclick = ()=>{
  // validate step2: file present or link
  const typ = field_map.type.value;
  if(typ==='Ebook'){
    const f = document.getElementById('step2_file');
    if(!f || !f.files || f.files.length===0){ markError(f||field_map.step2area,'PDF obrigat√≥rio'); (f||field_map.step2area).scrollIntoView({behavior:'smooth',block:'center'}); return; }
    // size limits
    const file = f.files[0];
    if(file.size < 3*1024*1024 || file.size > 18*1024*1024){ alert('PDF deve ter entre 3MB e 18MB'); return; }
    clearError(f);
  } else {
    const link = document.getElementById('step2_link');
    if(!link || !link.value.trim()){ markError(link,'Link obrigat√≥rio'); link.scrollIntoView({behavior:'smooth',block:'center'}); return; }
    clearError(link);
  }
  goToStep(3);
  startVerification();
};

s3_back.onclick = ()=> goToStep(2);

/* goToStep: show/hide and update progress */
function goToStep(n){
  step1.style.display = n===1 ? 'block':'none';
  step2.style.display = n===2 ? 'block':'none';
  step3.style.display = n===3 ? 'block':'none';
  progFill.style.width = (n===1? '33%': n===2 ? '66%': '100%');
}

/* verification chain (3~4s each), then enable finish */
function startVerification(){
  const vlist = field_map.verifyList; vlist.innerHTML='';
  const checks = [
    {key:'image', label:'Imagem do produto'},
    {key:'name', label:'Nome do produto'},
    {key:'file', label:'Arquivo / Link do produto'}
  ];
  let i=0;
  s3_finish.disabled = true;
  const interval = setInterval(()=>{
    if(i < checks.length){
      const div = document.createElement('div'); div.textContent = `‚úî ${checks[i].label} verificado`; vlist.appendChild(div);
      i++;
    } else {
      clearInterval(interval);
      const div = document.createElement('div'); div.textContent = 'Tudo OK ‚Äî pronto para finalizar';
      vlist.appendChild(div);
      s3_finish.disabled = false;
    }
  }, 3500);
}

/* finalize: save product (or update) */
s3_finish.onclick = async ()=>{
  // gather data
  // read image base64
  let imgData = field_map.image.dataset.preview || '';
  if(field_map.image.files && field_map.image.files[0]){
    imgData = await fileToBase64(field_map.image.files[0]);
  }
  const prod = {
    id: editingIndex!==null ? getProducts()[editingIndex].id : String(Date.now()),
    imageData: imgData,
    name: field_map.name.value.trim(),
    author: field_map.author.value.trim(),
    price: parseFloat(field_map.price.value)||0,
    discount: field_map.discount.value ? parseFloat(field_map.discount.value) : 0,
    coupon: field_map.coupon.value.trim(),
    description: field_map.description.value.trim(),
    category: field_map.category.value,
    type: field_map.type.value,
    affiliate: field_map.affiliate.value==='yes',
    commission: field_map.commission.value ? parseFloat(field_map.commission.value) : 0,
    affvalue: field_map.affvalue.value || '',
    afflink: field_map.afflink.value || '',
    status: 'Pendente',
    createdAt: new Date().toISOString()
  };
  const arr = getProducts();
  if(editingIndex!==null){ // update existing (but keep status Pendente if was)
    arr[editingIndex] = {...arr[editingIndex], ...prod};
  } else arr.push(prod);
  saveProducts(arr);
  closeModal();
  // show success and redirect after user closes or refresh
  const sb = document.getElementById('successBox'); sb.classList.add('open');
  document.getElementById('closeSuccess').onclick = ()=> sb.classList.remove('open');
  // auto redirect to meus_produtos view (here we are already in meus_produtos)
  setTimeout(()=> {
    sb.classList.remove('open');
    renderProducts();
  }, 2500);
};

/* helper to convert file -> base64 */
function fileToBase64(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

/* open modal on create button */
document.getElementById('createBtn').addEventListener('click', ()=> openModal(false,null));

/* close modal clicking outside */
modal.addEventListener('click', (e)=> { if(e.target===modal) closeModal(); });

/* initial render */
renderProducts();

/* search & filter functionality */
document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('categorySelect').addEventListener('change', applyFilters);

function applyFilters(){
  const term = document.getElementById('searchInput').value.toLowerCase();
  const cat = document.getElementById('categorySelect').value;
  const arr = getProducts().filter(p=>{
    const matchTerm = !term || (p.name && p.name.toLowerCase().includes(term));
    const matchCat = !cat || p.category === cat;
    return matchTerm && matchCat;
  });
  // render filtered
  productsGrid.innerHTML = '';
  if(arr.length===0){ productsGrid.innerHTML = '<div style="grid-column:1/-1;color:#94a3b8;text-align:center;padding:20px">Nenhum produto encontrado.</div>'; return; }
  arr.forEach((p,idx)=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<img src="${p.imageData||''}" alt=""><h4>${p.name}</h4><div class="meta">${p.type} ‚Ä¢ ${p.category} ‚Ä¢ ${p.author||''}</div><p class="meta">${(p.description||'').slice(0,120)}...</p><div style="margin-top:6px"><strong style="color:#c7f9ff">${p.price} MT</strong></div><div style="margin-top:6px"><span class="status-pill ${p.status==='Pendente'?'status-pendente':p.status==='Ativo'?'status-ativo':'status-inativo'}">${p.status}</span></div>`;
    const actions = document.createElement('div'); actions.className='card-actions';
    const copyBtn = document.createElement('button'); copyBtn.className='small-btn copy'; copyBtn.textContent='üìã Copiar link';
    copyBtn.onclick = ()=>{ navigator.clipboard?.writeText(`${location.origin}${location.pathname.replace(/[^\/]*$/,'')}produto.html?id=${encodeURIComponent(p.id)}`); alert('Link copiado'); };
    const editBtn = document.createElement('button'); editBtn.className='small-btn edit'; editBtn.textContent='‚úèÔ∏è Editar';
    if(p.status==='Pendente'){ editBtn.disabled=true; editBtn.style.opacity='.5'; editBtn.title='Edi√ß√£o bloqueada enquanto Pendente'; }
    else editBtn.onclick = ()=> { // find original index in all products
      const originalIndex = getProducts().findIndex(x=> x.id===p.id);
      openModal(true, originalIndex);
    };
    const delBtn = document.createElement('button'); delBtn.className='small-btn delete'; delBtn.textContent='üóëÔ∏è Remover';
    delBtn.onclick = ()=>{ if(confirm('Remover produto?')){ const all=getProducts(); const i = all.findIndex(x=>x.id===p.id); all.splice(i,1); saveProducts(all); } };
    actions.appendChild(copyBtn); actions.appendChild(editBtn); actions.appendChild(delBtn);
    card.appendChild(actions);
    productsGrid.appendChild(card);
  });
}

/* expose saveProducts for debug */
window.saveProducts = saveProducts;
</script>
</body>
</html>
